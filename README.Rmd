---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# enRUVseq

<!-- badges: start -->
<!-- badges: end -->

The goal of `enRUVseq` is to perform normalization on RNA-seq including enrichment (NAD-RNA-seq) using spike-in. 

The main functions for normalizing enrichment variation between samples were inspired by [RUVSeq](https://github.com/drisso/RUVSeq).

## Installation

You can install the development version from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("thereallda/enRUVseq")
```

## Spike-in > Non-spike-in (enRUVg)

If the spike-in is the predominant composition of the library, e.g., input RNA with 45ug spike-in and 5ug non-spike-in, uses `enRUVg`. 

### Workflow of `enRUVseq`

```{r}
library(enRUVseq)
library(tidyverse)
library(edgeR)
# load data
load('data/deg.enruvg.rda')

deg.enruvg
```

### Filtering low-expressed genes

```{r}
keep <- filterByExpr(deg.enruvg, group = deg.enruvg$samples$group)
deg.enruvg <- deg.enruvg[keep,]
```

### Calculating size factors

```{r}
# prefix of spike-in
spike_in_prefix <- '^FB'

# calculating RLE size factor based on spike-in
size_factors <- calcSizeFactors(deg.enruvg$counts, method = 'RLE', control.prefix = spike_in_prefix)
size_factors
```

### Estimate variation factors

Due to the first singular value (SV) in NAD-RNA-seq represent the difference between enrich and input libraries (see below PCA plot (equivalent to SVD)) which should not be removed, we estimated the variation factors after dropping the first SV. 

```{r}
ggPCA(deg.enruvg$counts, labels = deg.enruvg$samples$group, vst.norm = TRUE)
```

```{r}
# construct spike-in DGEList
spike_in_id <- grep(spike_in_prefix, rownames(deg.enruvg))
deg.spike <- DGEList(deg.enruvg$counts[spike_in_id,], group = deg.enruvg$samples$group)
deg.spike$samples$norm.factors <- size_factors
counts_norm <- cpm(deg.spike, log = TRUE)
# estimate the first 3 SV
W.ls <- enRUVg(counts_norm, isLog = TRUE, k = 4, drop = 1, control.idx = rownames(counts_norm)) # k starts with 2
str(W.ls)
```

### Perform DE analysis 

Next, we perform differential analysis between enrich and input with estimated variation factors using edgeR. 

```{r}
design.df <- data.frame(samples_group=deg.enruvg$samples$group, W.ls$W, row.names=colnames(deg.enruvg))
design.ruvg <- model.matrix(as.formula(paste("~0+",paste(colnames(design.df), collapse = '+'))), data=design.df)
design.ruvg
```

edgeR procedure

```{r}
deg.enruvg$samples$norm.factors <- size_factors
# non-spike-in genes
deg.enruvg2 <- deg.enruvg[grep(spike_in_prefix, rownames(deg.enruvg), invert = TRUE), ]
deg.enruvg2 <- estimateDisp(deg.enruvg2, design = design.ruvg)
fit.glm <- glmFit(deg.enruvg2)
```

```{r}
# make all contrast between enrich and input for each groups
ctrst <- unique(gsub("\\..*","",levels(deg.enruvg2$samples$group)))
ctrst.vec <- sapply(ctrst, function(i) {
  paste(paste0('samples_group', i, c(".Enrich", ".Input")), collapse = "-")
})
my.contrast <- makeContrasts(contrasts = ctrst.vec, levels = design.ruvg)
my.contrast
```

```{r}
lrt.ls <- apply(my.contrast, 2, function(x) glmLRT(fit.glm, contrast = x))
res.ls <- lapply(lrt.ls, topTags, n=Inf, adjust.method='BH')
# cut-off for NAD-RNA
res.sig.ls <- lapply(res.ls, function(x) subset(x$table, logFC > 1 & FDR < .05))
names(res.sig.ls) <- c("High", "Mid", "Low")
str(res.sig.ls)
```

### Visualization

```{r}
fc_df <- reduceRes(res.sig.ls, fc.col = 'logFC')
BetweenStatPlot(fc_df, x='Group', y='logFC', color='Group') + ggtitle("Non-spike-in After Normalization")
```


## Spike-in < Non-spike-in (enRUVs)

If the non-spike-in is the predominant composition of the library, e.g., input RNA with 5ug spike-in and 45ug non-spike-in, uses `enRUVs`. 

### Workflow of `enRUVs`

The only difference between `enRUVg` and `enRUVs` is how the variation factors being estimated.

In `enRUVs` the variation factors are estimated as follows

```{r, eval=FALSE}
scIdx <- matrix(data=c(1:3, 4:6), byrow=TRUE, nrow=2)
# > scIdx
#      [,1] [,2] [,3]
# [1,]    1    2    3
# [2,]    4    5    6
degs <- DGEList(counts_spike, group=samples_group)
degs$samples$norm.factors <- size_factors
counts_norm <- cpm(degs, log = T)
W.ls <- enRUVs(counts_norm, isLog = T, 
               k=i, 
               control.idx = grep(spike_in_prefix, rownames(counts_norm)),
               sc.idx = scIdx)

```

The estimated variation factors can be used in the edgeR procedure.

> <more details for enRUVs>
